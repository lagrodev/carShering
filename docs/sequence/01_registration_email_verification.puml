@startuml Registration Email Verification
title Регистрация и подтверждение email

skinparam backgroundColor white
skinparam sequenceArrowThickness 1
skinparam participant {
    BackgroundColor<<User>> #FFB6C1
    BackgroundColor<<Frontend>> #FFFACD
    BackgroundColor<<Server>> #ADD8E6
    BackgroundColor<<Database>> #E6E6FA
}

actor User <<User>>
participant "Frontend" as Frontend <<Frontend>>
participant "API" as API <<Server>>
database "Database" as DB <<Database>>

== Регистрация ==

User -> Frontend: Заполняет форму регистрации
Frontend -> Frontend: Валидация полей
User -> Frontend: Нажимает "Зарегистрироваться"

Frontend -> API: POST /api/registration\n{email, password, firstName, lastName, phone}

API -> DB: Проверить уникальность email
DB --> API: Email свободен

API -> API: Хеширование пароля (BCrypt)

API -> DB: Сохранить нового клиента
DB --> API: Клиент создан

API -> API: Генерация 6-значного кода

API -> DB: Сохранить код подтверждения
DB --> API: Код сохранён

API -> API: Отправить email с кодом

API --> Frontend: 201 Created + данные клиента
Frontend -> Frontend: Обновить интерфейс
Frontend --> User: Показать форму ввода кода

== Подтверждение Email ==

User -> Frontend: Вводит код из письма
Frontend -> API: POST /api/verify-email {email, code}

API -> DB: Найти код по email
DB --> API: Код найден

alt Код неверный или истёк
    API --> Frontend: 400 Bad Request
    Frontend --> User: Показать ошибку
else Код верный
    API -> DB: Обновить emailVerified = true
    DB --> API: Клиент обновлён

    API -> DB: Удалить использованный код
    DB --> API: Код удалён

    API --> Frontend: 200 OK
    Frontend --> User: Перенаправить на страницу входа
end

@enduml

